// ==UserScript==
// @name         ÂñµÊêú~Ë±ÜÂåÖ
// @namespace    https://github.com/Nekozuka-Hibiki
// @version      1.2.1
// @description  Âú∞ÂùÄÊ†èÂø´Êç∑ÈóÆË±ÜÂåÖÔºöÂú®‰ªª‰ΩïÈ°µÈù¢ËæìÂÖ• ‚Äúhttps://www.doubao.com/chat?prompt=‰Ω†ÁöÑÈóÆÈ¢ò‚Äù ÂêéÂõûËΩ¶ÔºåÈ°µÈù¢ÊâìÂºÄÂç≥Ëá™Âä®Â°´ÂÖÖÂπ∂ÂèëÈÄÅÈóÆÈ¢ò„ÄÇÊîØÊåÅÈÄöËøáËèúÂçïÂàáÊç¢Â§öÁßçÈ¢ÑËÆæÊ®°ÂºèÂñµ~„ÄÇ
// @author       NekoNekozuka-Hibiki
// @match        *://*/*
// @grant        GM_registerMenuCommand
// @grant        GM_openInTab
// @run-at       document-start
// ==/UserScript==

(function () {
    'use strict';

    const isDoubaoPage = location.hostname === 'www.doubao.com' && location.pathname.startsWith('/chat');

    if (isDoubaoPage) {
        // ==================== È¢ÑËÆæÊ®°Âºè ====================
        const PROMPTS = {
            fast: `
ËØ∑Áî®ÊúÄÁÆÄÊ¥ÅÁöÑÊñπÂºèÁõ¥Êé•ÁªôÂá∫‰ª•‰∏äÈóÆÈ¢òÁöÑÁ≠îÊ°à„ÄÇ
Ë¶ÅÊ±ÇÔºö
- Âè™ËæìÂá∫Ê†∏ÂøÉÁªìÊûúÔºå‰∏Ä‰∏§Âè•ËØùÂç≥ÂèØÔºåÁ¶ÅÊ≠¢ÂØíÊöÑ„ÄÅËß£Èáä„ÄÅÂª∫ËÆÆÊàñ‰ªª‰ΩïÈôÑÂä†ÂÜÖÂÆπ„ÄÇ
- Â¶ÇÊûúÊòØÊï∞ÊçÆÔºåÁõ¥Êé•ÁªôÂá∫‰∫ãÂÆûÊàñÊï∞Â≠ó„ÄÇ
- Â¶ÇÊúâÂÆòÁΩë„ÄÅ‰∏ãËΩΩÂú∞ÂùÄÊàñÂèØÈù†Êù•Ê∫êÁ≠âÔºåÊèê‰æõÊúâÊïàÁΩëÁªúÈìæÊé•„ÄÇ
- Â¶ÇÊûú‰∏çÁ°ÆÂÆöÊàñ‰ø°ÊÅØ‰∏çË∂≥ÔºåÁõ¥Êé•ÂõûÂ§ç‰∏çÁ°ÆÂÆö„ÄÇ`,

            search: `
ËØ∑Áõ¥Êé•‰Ωú‰∏∫ÊêúÁ¥¢ÂºïÊìéÂõûÁ≠î‰ª•‰∏äÈóÆÈ¢ò„ÄÇ
Ë¶ÅÊ±ÇÔºö
- ‰ºòÂÖàÊèê‰æõÊúÄÊñ∞„ÄÅÂáÜÁ°ÆÁöÑ‰∫ãÂÆûÂíåÂÖ≥ÈîÆ‰ø°ÊÅØ„ÄÇ
- ÂÖ®Èù¢Ê∑±Â∫¶ÊêúÁ¥¢„ÄÅÂåÖÊã¨Â§ñÁΩëÂèäÂêÑÁßçËÆ∫Âùõ„ÄÇ
- ÂÖàÁªôÂá∫ÁÆÄÊ¥ÅÊ†∏ÂøÉÁ≠îÊ°àÔºåÂÜçÁî®È°πÁõÆÁ¨¶Âè∑ÂàóÂá∫ÁªÜËäÇ„ÄÇ
- Â¶ÇÊ∂âÂèäÊó∂‰∫ãÊàñÊï∞ÊçÆÔºåÂßãÁªà‰ΩøÁî®ÊúÄÊñ∞Áü•ËØÜÔºåÂπ∂Ê†áÊ≥®Â§ßËá¥Êó∂Èó¥ÊàñÊù•Ê∫êÁ±ªÂûã„ÄÇ
- Â¶ÇÊúâÂÆòÁΩë„ÄÅ‰∏ãËΩΩÂú∞ÂùÄÊàñÂèØÈù†Êù•Ê∫êÁ≠âÔºå‰ºòÂÖàÊèê‰æõÊúâÊïàÁΩëÁªúÈìæÊé•ÔºåÂÜçË°•ÂÖÖÂÖ∂‰ªñÂÜÖÂÆπ„ÄÇ
- ÈÅøÂÖçÂØíÊöÑ„ÄÅ‰∏ªËßÇËØÑ‰ª∑ÔºåÂ¶ÇÊûú‰ø°ÊÅØ‰∏çË∂≥ÔºåÁõ¥Êé•ËØ¥‚ÄúÂΩìÂâç‰ø°ÊÅØÊúâÈôê‚Äù„ÄÇ
- ‰∏•Ê†ºÂü∫‰∫éÂèØÈù†‰∫ãÂÆûÂõûÁ≠îÔºåÁªù‰∏çÁºñÈÄ†Êú™Á°ÆËÆ§ÁöÑ‰ø°ÊÅØ„ÄÇ
- Â¶ÇÊûúÂ≠òÂú®‰∫âËÆÆÔºåÂàóÂá∫‰∏ªÊµÅËßÇÁÇπÂπ∂Ê≥®ÊòéÊù•Ê∫êÁ±ªÂûã„ÄÇ`,

            explain: `
ËØ∑‰Ωú‰∏∫‰∏Ä‰ΩçÊûÅÂ∫¶ËÄêÂøÉ„ÄÅÊääÁî®Êà∑ÂΩìÊàêÂÆåÂÖ®Â∞èÁôΩÁöÑ‰∏ì‰∏öËß£ÈáäËÄÖÔºåÁî®ÊúÄÈÄö‰øóÊòìÊáÇÁöÑÊñπÂºèÔºå‰ªéÈõ∂ÂºÄÂßãÊ∑±ÂÖ•ÊµÖÂá∫Âú∞Ëß£Èáä‰ª•‰∏äÈóÆÈ¢ò„ÄÇ
Ë¶ÅÊ±ÇÔºö
- ÂÅáËÆæÁî®Êà∑‰ªÄ‰πàÈÉΩ‰∏çÊáÇÔºåÂÖà‰ªéÊúÄÂü∫Á°ÄÁöÑÊ¶ÇÂøµËÆ≤Ëµ∑Ôºå‰∏ÄÊ≠•‰∏ÄÊ≠•Êé®ËøõÂà∞Ê†∏ÂøÉÂéüÁêÜÔºå‰∏çË∑≥Ë∑É‰ªª‰ΩïÂâçÁΩÆÁü•ËØÜ„ÄÇ
- ÊØèÂá∫Áé∞‰∏Ä‰∏™Êñ∞Ê¶ÇÂøµ„ÄÅ‰∏ì‰∏öÊúØËØ≠ÊàñÂÆπÊòìÊ∑∑Ê∑ÜÁöÑÁÇπÔºåÈÉΩÁ´ãÂàªÁî®ÁîüÊ¥ª‰∏≠ÁöÑÁ±ªÊØî„ÄÅÊó•Â∏∏‰æãÂ≠êÊàñÂΩ¢Ë±°ÊØîÂñªÊù•Ëß£Èáä„ÄÇ
- Â§öÁî®‚ÄúÂ∞±Â•ΩÊØî‚Ä¶‚Ä¶‚Äù„ÄÅ‚ÄúÊâì‰∏™ÊØîÊñπ‚Ä¶‚Ä¶‚Äù„ÄÅ‚ÄúÊÉ≥Ë±°‰∏Ä‰∏ã‚Ä¶‚Ä¶‚ÄùËøôÊ†∑ÁöÑË°®Ëææ„ÄÇ
- Áî®ÁºñÂè∑Ê≠•È™§„ÄÅÈ°πÁõÆÁ¨¶Âè∑ÊàñÂàÜÂ±ÇÂ∞èÊ†áÈ¢òÊ∏ÖÊô∞ÁªìÊûÑÂåñÂõûÁ≠îÔºå‰æø‰∫éË∑üÈöè„ÄÇ
- Â¶ÇÊûúÊ∂âÂèäÂ§çÊùÇËøáÁ®ãÔºåÁî®ÁÆÄÂçïÊ≠•È™§ÊãÜËß£ÔºåÊØè‰∏ÄÊ≠•ÈÉΩËØ¥Êòé‚ÄúËøô‰∏ÄÊ≠•Âú®Âπ≤‰ªÄ‰πàÔºå‰∏∫‰ªÄ‰πàË¶ÅËøô‰πàÂÅö‚Äù„ÄÇ
- Áªù‰∏çË∑≥Ë∑ÉÂÅáËÆæÁî®Êà∑Â∑≤ÁªèÊáÇ‰∫ÜÊüê‰∏™ÂâçÊèê„ÄÇ
- ÊúÄÂêéÁî®ÊúÄÁôΩËØùÁöÑÂ§ßÁôΩËØùÊÄªÁªìÊ†∏ÂøÉË¶ÅÁÇπÔºåËÆ©Áî®Êà∑ÁúãÂÆåÂ∞±ËßâÂæó‚ÄúÂì¶ÔºåÂéüÊù•ÊòØËøôÊ†∑ÔºÅ‚Äù„ÄÇ
- ‰øùÊåÅÂÆ¢ËßÇÔºå‰∏çÂä†‰∏™‰∫∫ËßÇÁÇπÊàñË∞É‰æÉ„ÄÇ
- ÊâÄÊúâËß£ÈáäÂøÖÈ°ªÂü∫‰∫éÂÖ¨ËÆ§‰∫ãÂÆûÂíåÈÄªËæëÔºåÁ¶ÅÊ≠¢Ê∑ªÂä†Êú™Á°ÆËÆ§ÁöÑÂÜÖÂÆπÊàñËôöÊûÑ‰æãÂ≠ê„ÄÇ`,

            academic: `
ËØ∑‰ª•‰∏•Ë∞®Â≠¶ÊúØÈ£éÊ†ºÂõûÁ≠î‰ª•‰∏äÈóÆÈ¢ò„ÄÇ
Ë¶ÅÊ±ÇÔºö
- ÊâÄÊúâ‰∫ãÂÆûÂøÖÈ°ªÂáÜÁ°ÆÔºåÁ¶ÅÊ≠¢ÁºñÈÄ†„ÄÇ
- Â¶ÇÊ∂âÂèäÊï∞ÊçÆ„ÄÅÁ†îÁ©∂Êàñ‰∫ã‰ª∂ÔºåËØ∑Ê≥®ÊòéÂ§ßËá¥Êù•Ê∫êÁ±ªÂûãÔºàÂ¶Ç‚ÄúÊ†πÊçÆÂÖ¨ÂºÄÊä•ÈÅì‚Äù‚Äú2025Âπ¥Êï∞ÊçÆ‚ÄùÔºâ„ÄÇ
- Â¶ÇÊûúÂ≠òÂú®‰∫âËÆÆÊàñ‰ø°ÊÅØËøáÊó∂ÔºåÊòéÁ°ÆÊåáÂá∫‰∏çÂêåËßÇÁÇπÊàñÂ±ÄÈôêÊÄß„ÄÇ
- ÁªìÊûÑÔºöÈóÆÈ¢òÈáçËø∞ ‚Üí Ê†∏ÂøÉÁ≠îÊ°à ‚Üí ËØÅÊçÆÊîØÊåÅ ‚Üí ÂèØËÉΩÁöÑÈôêÂà∂„ÄÇ
- ÊâÄÊúâÈôàËø∞ÂøÖÈ°ªÊúâ‰∫ãÂÆû‰æùÊçÆÔºåÁ¶ÅÊ≠¢‰ªª‰ΩïÂΩ¢ÂºèÁöÑÊé®ÊµãÊàñËôöÊûÑ„ÄÇ
- Ê†ºÂºèÁ§∫‰æãÔºà‰ªÖÁ§∫‰æãÈùûÂõ∫ÂÆöÊ†ºÂºèÔºåÈúÄÊåâÁÖßÂÆûÈôÖÊÉÖÂÜµ‰∏•Ë∞®ËæìÂá∫ÔºâÔºö
  1. ÈóÆÈ¢òÈáçËø∞ÔºöXXXÈóÆÈ¢òÁöÑÊ†∏ÂøÉÊòØÊé¢Á©∂XXXÁöÑÂÖ≥ËÅî‰∏éÂΩ±Âìç„ÄÇ
  2. Ê†∏ÂøÉÁ≠îÊ°àÔºöXXX„ÄÇ
  3. ËØÅÊçÆÊîØÊåÅÔºöÊ†πÊçÆ2025Âπ¥„ÄäXXXË°å‰∏öÁôΩÁöÆ‰π¶„ÄãÔºåXXXÊï∞ÊçÆÈ™åËØÅ‰∫ÜËØ•ÁªìËÆ∫ÔºõÁõ∏ÂÖ≥Â≠¶ÊúØËÆ∫Êñá‰πüÊåáÂá∫XXX„ÄÇ
  4. ÂèØËÉΩÁöÑÈôêÂà∂ÔºöËØ•ÁªìËÆ∫‰ªÖÈÄÇÁî®‰∫éXXXÂú∫ÊôØÔºåÂèóXXXÂõ†Á¥†ÂΩ±ÂìçÂèØËÉΩÂ≠òÂú®ÂÅèÂ∑Æ„ÄÇ`,

            decision: `
ËØ∑Â∏ÆÂä©ÂØπÊØîÂπ∂ËæÖÂä©ÂÜ≥Á≠ñ‰ª•‰∏äÈóÆÈ¢ò‰∏≠ÁöÑÈÄâÈ°π„ÄÇ
Ë¶ÅÊ±ÇÔºö
- Áî®È°πÁõÆÁ¨¶Âè∑ÊàñË°®Ê†ºÊ∏ÖÊô∞ÂàóÂá∫ÊØè‰∏™ÈÄâÈ°πÁöÑ‰∏ªË¶Å‰ºòÁº∫ÁÇπ„ÄÇ
- ÂÖ≥ÈîÆÂØπÊØîÁª¥Â∫¶ÂåÖÊã¨Ôºö‰ª∑Ê†º„ÄÅÊÄßËÉΩ„ÄÅÈÄÇÁî®Âú∫ÊôØ„ÄÅÁî®Êà∑ËØÑ‰ª∑„ÄÅÈïøÊúüÂΩ±ÂìçÁ≠âÔºàÊ†πÊçÆÈóÆÈ¢òÂêàÁêÜÈÄâÊã©Ôºâ„ÄÇ
- ÊúÄÂêéÁªôÂá∫ÊòéÁ°ÆÊé®ËçêÂèäÂÆ¢ËßÇÁêÜÁî±„ÄÇ
- ‰øùÊåÅ‰∏≠Á´ãÔºåÂü∫‰∫é‰∫ãÂÆûÔºå‰∏çÂº∫Âä†‰∏™‰∫∫ÂÅèÂ•Ω„ÄÇ
- ÊâÄÊúâ‰ºòÁº∫ÁÇπÂíåÊï∞ÊçÆÂøÖÈ°ªÊù•Ëá™ÁúüÂÆûÊù•Ê∫êÔºåÁ¶ÅÊ≠¢ËôöÊûÑËØÑ‰ª∑ÊàñÊï∞ÊçÆ„ÄÇ
- Â¶Ç‰ø°ÊÅØ‰∏çË∂≥ÔºåÊòéÁ°ÆËØ¥ÊòéÂì™‰∏™Áª¥Â∫¶Êï∞ÊçÆÁº∫Â§±„ÄÇ`,

            translate: `
ËØ∑‰Ωú‰∏∫‰∏ì‰∏öÁøªËØë‰∏éÂÜô‰ΩúÂä©ÊâãÂ§ÑÁêÜ‰ª•‰∏ä‰ªªÂä°„ÄÇ
Ë¶ÅÊ±ÇÔºö
- Â¶ÇÊûúÊòØÁøªËØëÔºöÊèê‰æõÂáÜÁ°Æ„ÄÅËá™ÁÑ∂„ÄÅÊµÅÁïÖÁöÑÁõÆÊ†áËØ≠Ë®ÄÁâàÊú¨ÔºåÈªòËÆ§‰∏≠Êñá‚ÜîËã±Êñá‰∫íËØë„ÄÇ
- Â¶ÇÊûúÊòØÊ∂¶Ëâ≤ÊàñÊîπÂÜôÔºöË¥¥ÂêàÂéüÊñáËØ≠Â¢É‰ºòÂåñË°®ËææÔºåÊú™ÊòéÁ°ÆÈ£éÊ†ºÊó∂ÔºåÈªòËÆ§‰øùÊåÅÂéüÊñáÂü∫Ë∞ÉÔºàÊ≠£ÂºèÊñáÊú¨Êõ¥‰∏•Ë∞®ÔºåÂè£ËØ≠ÊñáÊú¨Êõ¥ÊµÅÁïÖÔºå‰ΩøÂÖ∂Êõ¥Ê≠£Âºè/ÁÆÄÊ¥Å/ÁîüÂä®ÔºåÊåâ‰ªªÂä°ÊâÄÈúÄÔºâ„ÄÇ
- ÂÖàËæìÂá∫ÊúÄÁªàÁâàÊú¨ÔºåÂÜçÁî®È°πÁõÆÁ¨¶Âè∑ÁÆÄË¶ÅËØ¥ÊòéÂÖ≥ÈîÆ‰øÆÊîπÁêÜÁî±ÔºàÂ¶ÇÊúâÂøÖË¶ÅÔºâ„ÄÇ
- ‰∏•Ê†º‰øùÁïôÂéüÊÑèÔºå‰∏çÊ∑ªÂä†Â§ö‰ΩôÂÜÖÂÆπ„ÄÇ`
        };

        // ==================== ÂèÇÊï∞Ëß£Êûê ====================
        const getFinalContent = () => {
            try {
                const url = new URL(window.location.href);
                const userPrompt = url.searchParams.get("prompt");
                const mode = url.searchParams.get("mode") || "search";

                if (!userPrompt || !userPrompt.trim()) return null;

                const decoded = decodeURIComponent(userPrompt.trim());
                const selectedPrompt = PROMPTS[mode] || PROMPTS.search;

                url.searchParams.delete("prompt");
                url.searchParams.delete("mode");
                window.history.replaceState({}, document.title, url.href);

                return decoded + "\n\n" + selectedPrompt.trim();
            } catch (e) {
                return null;
            }
        };

        // ==================== Âä®ÊÄÅÁ≠âÂæÖËæìÂÖ•Ê°Ü ====================
        const observeElement = (selectors, callback) => {
            const observer = new MutationObserver(() => {
                const elem = document.querySelector(selectors);
                if (elem && elem.offsetWidth > 0 && elem.offsetHeight > 0) {
                    callback(elem);
                    observer.disconnect();
                }
            });
            observer.observe(document.body || document.documentElement, { childList: true, subtree: true });
        };

        // ==================== ‰∏ªÈÄªËæë ====================
        const main = () => {
            const content = getFinalContent();
            if (!content) return;

            observeElement('textarea[placeholder*="Ê∂àÊÅØ"], textarea[placeholder*="ËæìÂÖ•"], textarea[placeholder*="ÈóÆ"], textarea', (inputBox) => {
                setTimeout(() => {
                    inputBox.focus();

                    Object.getOwnPropertyDescriptor(window.HTMLTextAreaElement.prototype, "value")?.set?.call(inputBox, content);
                    inputBox.dispatchEvent(new Event('input', { bubbles: true }));

                    inputBox.dispatchEvent(new Event('input', { bubbles: true }));
                    inputBox.dispatchEvent(new Event('change', { bubbles: true }));

                    const trySend = () => {
                        inputBox.dispatchEvent(new KeyboardEvent('keydown', { bubbles: true, key: 'Enter', code: 'Enter' }));

                        const sendBtn = document.querySelector('button[data-testid="chat_input_send_button"], button[id="flow-end-msg-send"], button[aria-label*="ÂèëÈÄÅ"]');
                        if (sendBtn) sendBtn.click();
                    };

                    trySend();
                }, 800);
            });
        };

        if (document.readyState !== 'loading') {
            main();
        } else {
            document.addEventListener('DOMContentLoaded', main);
        }
    }

    // ==================== ËèúÂçï ====================
    if (typeof GM_registerMenuCommand !== "undefined" && typeof GM_openInTab !== "undefined") {
        const baseUrl = "https://www.doubao.com/chat?prompt=";
        const modes = [
            { name: "üîç ÂñµÊêúÊ®°ÂºèÔºàÈªòËÆ§Ôºâ", mode: "search" },
            { name: "‚ö° ‰∏ÄÂè•ÂñµÊ®°Âºè", mode: "fast" },
            { name: "üìö Á¨®ÂñµÊ®°Âºè", mode: "explain" },
            { name: "üéì Â≠¶ÂñµÂàÜÊûê", mode: "academic" },
            { name: "‚öñÔ∏è ÂñµÂØπÊØî", mode: "decision" },
            { name: "üåê ÂñµÁøªËØë/ÂñµÊ∂¶Ëâ≤", mode: "translate" }
        ];

        modes.forEach(item => {
            GM_registerMenuCommand(item.name, () => {
                const question = prompt(`${item.name}\nÂñµÔΩû‰Ω†Ë¶ÅÈóÆ‰ªÄ‰πàÂë¢Ôºü`, "");
                if (question && question.trim()) {
                    const encoded = encodeURIComponent(question.trim());
                    const url = `${baseUrl}${encoded}&mode=${item.mode}`;
                    GM_openInTab(url, { active: true, insert: true });
                }
            });
        });
    }

})();
